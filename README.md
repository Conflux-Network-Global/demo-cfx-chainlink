# Conflux Network + Chainlink: Demo

Demonstrating how to connect Conflux Network and Chainlink together, and thus bringing the world of oracles to Conflux Network. This is a simple demonstration of how to use an [external initiator](https://github.com/smartcontractkit/chainlink/wiki/External-Initiators) (EI) and [external adapter](https://github.com/smartcontractkit/chainlink/wiki/External-Adapters) (EA) to trigger Chainlink node runs from a smart contract on Conflux Network and pass the information back.

## Setup Steps
Generalized setup steps for the configuration of Chainlink components - more details are provided for connecting the various pieces together. Please see [Chainlink](https://docs.chain.link/docs)/[Conflux](https://developer.conflux-chain.org/) documentation if more details on configuration and setup are needed.

Before configuring the Chainlink components, there needs to be an oracle contract on the Conflux Network that emits events. This is needed for the EI to trigger job runs on the Chainlink node. See the [contractInteraction](./contractInteraction) folder for code to interact with the Conflux Network.

### Running a Chainlink Node
This step involves running a Chainlink node from a docker container as specified in the [developer documentation](https://docs.chain.link/docs/running-a-chainlink-node). Below is a sample `.env` file that should be included in the `\.chainlink*` folder.  
_Note: An ETH client URL is not required_
```
ROOT=/chainlink
LOG_LEVEL=debug
ETH_CHAIN_ID=3
MIN_OUTGOING_CONFIRMATIONS=2
LINK_CONTRACT_ADDRESS=0x20fe562d797a42dcb3399062ae9546cd06f63280
CHAINLINK_TLS_PORT=0
SECURE_COOKIES=false
ALLOW_ORIGINS=*
DATABASE_TIMEOUT=0
DATABASE_URL=DATABASE_URL=postgresql://$USERNAME:$PASSWORD@$SERVER:$PORT/$DATABASE
ETH_DISABLED=true
FEATURE_EXTERNAL_INITIATORS=true
CHAINLINK_DEV=true
```
Then the following command is run (_note: may be different depending on folder configuration_)
```
cd ~/.chainlink-ropsten && docker run -p 6688:6688 -v ~/.chainlink-ropsten:/chainlink -it --env-file=.env smartcontract/chainlink local n
```

During setup, a node password and a username/password is required for setup. The node password is used each time the node is started. The username/password is used for accessing the node UI at `http://localhost:6688` and for other parts of setup.

### Setting Up an External Initiator
External initiators observe a blockchain node endpoint and will trigger runs on the Chainlink node.  
_Note: Prerequisite for Go to be installed. See [here](https://golang.org/doc/install) for instructions._

Clone and build the external initiator repository (forked from main repository to adapt for Conflux Network)
```
git clone https://github.com/aalu1418/external-initiator
cd external-initiator
go build
```

Create a `.env` file in the `external-initiator` folder with the following contents:
```
EI_DATABASEURL=postgresql://$USERNAME:$PASSWORD@$SERVER:$PORT/$DATABASE
EI_CHAINLINKURL=http://localhost:6688
EI_IC_ACCESSKEY=<INSERT KEY>
EI_IC_SECRET=<INSERT KEY>
EI_CI_ACCESSKEY=<INSERT KEY>
EI_CI_SECRET=<INSERT KEY>
```
_Note: the database URL should be separate from the Chainlink node database_

The 4 keys in the `external-initiator/.env` file are generated by the Chainlink node with the following process. [Link](https://docs.chain.link/docs/miscellaneous) to more Chainlink/Docker documentation.
1. Use `docker ps` and obtain the container ID for the Chainlink node. To access the command line within the container, use `docker exec -it <containerID> /bin/bash`.
1. Once inside the container, log in using `chainlink admin login` and the username/password from when the container is created.
1. To create the keys, `chainlink initiators create <NAME> <URL>`. Note that in this case the url is `http://172.17.0.1:8080` to access the locally run external-initiator using the docker container gateway. (otherwise, they are on two different networks). The 4 keys are generated in the same order as listed above.

The external initiator can be started up using:
```
./external-initiator "{\"name\":\"cfx-mainnet\",\"type\":\"conflux\",\"url\":\"http://mainnet-jsonrpc.conflux-chain.org:12537\"}" --chainlinkurl "http://localhost:6688/"
```
Where the url can be changed to the respective endpoint. In this case, it is pointed at the public Conflux Network testnet endpoint. For reliability purposes, do not use this in production; it is much more reliable to connect to a non-public endpoint.

### Creating a Bridge for an External Adapter
A sample external adapter is provided in the [CFX_externalAdapter](./CFX_externalAdapter) folder. It is a simple server built using Express that receives a post API call from the Chainlink node and sends the information to the smart contract on Conflux Network.

It requires a `.env` file in the `/CFX_externalAdapter` folder that contains:
```
TOKEN=<BRIDGE TOKEN>
PRIVATE_KEY=<ACCOUNT PRIVATE KEY>
```
The token is obtained when a bridge is created - following the instructions [here](https://docs.chain.link/docs/node-operators). The private key is the private key to an address that allows the external adapter to send transactions to Conflux Network.

Don't forget to install packages with `yarn` and then start it with `yarn start`. It will start the external adapter on `http://localhost:5000`. In this case, the bridge was created the name `testbridge` and using `http://172.17.0.1:5000` to access the local network from the containerized Chainlink node.

### Connecting Everything Together
In order to create the connection between the external initiator and Chainlink node, a job run on the node needs to be created. This can be done by accessing the node via the `localhost:6688` address and logging in. The full job spec is shown below and can be found [here](./EI_jobSpecs/EI_full.json):

```
{
  "initiators": [
    {
      "type": "external",
      "params": {
        "name": "cfx",
        "body": {
          "endpoint": "cfx-mainnet",
          "addresses": ["0x8aa73841e0a0e6e816b2c66c9c5ed1e144ad8cbb"]
        }
      }
    }
  ],
  "tasks": [
    {
      "type": "HttpGet",
      "params": {
        "get": "http://worldtimeapi.org/api/ip"
      }
    },
    {
      "type": "JSONParse",
      "params": { "path": ["unixtime"] }
    },
    { "type": "EthUint256" },
    { "type": "testbridge" }
  ]
}
```
The simple job spec shows that an external initiator is used to trigger a set of tasks where the last one `testbridge` is an external adapter that returns information to Conflux Network. The `name` in the initiator portion is the same name as entered when using the `chainlink initiators create <NAME> <URL>` command. The `endpoint` is the same name used in the external initiator startup command. The `addresses` are the contract addresses on Conflux Network.

When run job is called on the node, it will trigger a test payload in the EI that is sent to the network. The test payload contains a `cfx_epochNumber`, and upon successful return to the node, the EI begins polling the Conflux Network endpoint periodically (~5 seconds). When it catches an event using `cfx_getLogs`, it will trigger the tasks in the job specification. At the end of the tasks, the information is sent to the `testbridge` external adapter and sent back to the smart contract.

### Notes
- This is a demonstration integration, there are many improvements that can be made from a increased security, code optimization, and testing perspectives
- To do: test cases for CFX EI
